<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../neon-animation/neon-animated-pages.html">
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../t-button/t-button.html">
<link rel="import" href="../t-input/t-input.html">
<link rel="import" href="../t-password-input/t-password-input.html">
<link rel="import" href="../t-text-container/travel-element-styles.html">
<link rel="import" href="../neon-animation/neon-animatable.html">
<link rel="import" href="../neon-animation/animations/slide-from-right-animation.html">
<link rel="import" href="../neon-animation/animations/slide-left-animation.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<dom-module id="t-forgot-password">
    <template>
        <style include="travel-element-styles">
        :host,
        #pages {
            display: block;
            height: 100%;
        }
        
        .emailSent-list {
            margin-left: 12px;
        }
        
        #toast {
            --paper-toast-background-color: var(--error-color, #FF0000);
            --paper-toast-color: white;
        }
        </style>
        <paper-toast id="toast" text="No account found with your username"></paper-toast>
        <neon-animated-pages id="pages" selected="[[selectedPage]]" entry-animation="slide-from-right-animation" exit-animation="slide-left-animation" attr-for-selected="name">
            <neon-animatable name="forgotPassword">
                <div class="section">
                    <p class="margin-bottom font-14">To help us reset your password, please provide your username</p>
                    <t-input class="margin-bottom-large" id="username" name="username" label="Username" pattern='^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$' error-message="Please enter a valid email as username" required value="{{username}}"></t-input>
                    <t-button id="btnGetUser" class="primary block" label="Reset My Password" on-tap="_usernameSubmit"></t-button>
                </div>
            </neon-animatable>
            <neon-animatable name="securityQuestion">
                <div class="section">
                    <p class="margin-bottom font-14">Question: [[passwordQuestion]]</p>
                    <t-input class="margin-bottom-large" id="securityAnswer" name="securityAnswer" label="Security Answer" required value="{{securityAnswer}}"></t-input>
                    <t-button id="btnSecurityAnswer" class="primary block margin-bottom" label="Continue" on-tap="_securityAnswerSubmit"></t-button>
                    <p class="font-12 secondary-text">
                        If you don't rememeber your security answer, please <span class="link-style" on-tap="sendPasswordResetLink">click here</span> to get password reset mail in your inbox.
                    </p>
                </div>
            </neon-animatable>
            <neon-animatable name="newPassword">
                <div class="section">
                    <t-password-input class="margin-bottom-large" id="newPassword" name="newPassword" label="New Password" required value="{{newPassword}}"></t-password-input>
                    <t-button id="btnResetPassword" class="primary block margin-bottom" label="Reset Password" on-tap="_newPasswordSubmit"></t-button>
                </div>
            </neon-animatable>
            <neon-animatable name="emailSent">
                <div class="section font-12">
                    <div class="font-22 margin-bottom-medium">Password reset email sent successfully.</div>
                    <div class="font-14">In the next 30 minutes, you must follow these steps.</div>
                    <ol class="emailSent-list secondary-text margin-bottom-medium">
                        <li>Open the email sent to [[username]]</li>
                        <li>Click the link in the email to be taken to the page where you will create new password</li>
                        <!-- <li>Save the new password.</li> -->
                    </ol>
                    <a class="link-style" on-tap="_goSignInPage">Back to sign in</a>
                </div>
            </neon-animatable>
        </neon-animated-pages>
    </template>
</dom-module>
<script>
Polymer({
    is: "t-forgot-password",

    properties: {

        /* *
         * The selected page when forgot password is opened.
         * Must be a iether of forgotPassword,
         * securityQuestion,newPassword,emailSent
         */
        selectedPage: {
            type: String,
            value: 'forgotPassword'
        },

        /* *
         * Sets the password question which returns from API
         */
        passwordQuestion: {
            type: String,
            value: 'What is your nickname?'
        }


    },
    _disableButton: function(element) {
        element.disabled = true;
    },
    _enableButton: function(element) {
        element.disabled = false;
    },

    _usernameSubmit: function(e) {
        //checking if valid email for username
        if (!this.$.username.validate()) {
            return;
        }

        this._disableButton(e.currentTarget);

        this.fire('t-forgot-password-get-user', {
            userName: this.$.username.value
        }, {
            bubbles: true
        });
    },

    onGetUserResponse: function(data) {
        if (data) {
            if (data.result) {
                this.passwordQuestion = data.result
                this.$.pages.select('securityQuestion');
            } else {
                this.sendPasswordResetLink();
            }
        } else
            this._enableButton(this.$.btnGetUser);
    },

    _securityAnswerSubmit: function(e) {
        //checking if valid email for username
        if (!this.$.securityAnswer.validate()) {
            return;
        }
        this._disableButton(e.currentTarget);

        this.fire('t-forgot-password-verify-secret', {
            userName: this.$.username.value,
            question: this.passwordQuestion,
            answer: this.$.securityAnswer.value
        }, {
            bubbles: true
        });
    },

    onGetSecretAnswerResponse: function(data) {
        if (data) {
            this.userToken = data.authenticationToken;
            this.$.pages.select('newPassword');
        } else
            this._enableButton(this.$.btnSecurityAnswer);
    },

    _newPasswordSubmit: function(e) {
        //checking if valid email for username
        if (!this.$.newPassword.validate()) {
            return;
        }
        this._disableButton(e.currentTarget);

        this.fire('t-forgot-password-update-password', {
            newPassword: this.$.newPassword.value,
            userToken: this.userToken
        }, {
            bubbles: true
        });
    },

    onPasswordResetResponse: function(data) {
        //slide to SIGN IN PAGE. Note this function should ideally go to the on-response function of the ajax call
        if (data)
            this._goSignInPage();
        else
            this._enableButton(this.$.btnResetPassword);
    },

    _goSignInPage: function() {
        this.fire('go-signin');
        // alert('Go to signin page');
    },

    /* *
     * function to send password reset link.
     */
    sendPasswordResetLink: function() {
        this.fire('t-forgot-password-send-email', {
            userName: this.$.username.value
        }, {
            bubbles: true
        });
    },

    onEmailSent: function(data) {
        if (data)
            this.$.pages.select('emailSent');
    }
});
</script>
